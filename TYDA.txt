
================================================================================
GUIA DE INTEGRA√á√ÉO TYDA: CLOUD AUTH + LOCAL DATABASE
================================================================================

Este projeto utiliza uma arquitetura h√≠brida:
- AUTENTICA√á√ÉO: Supabase Cloud.
- DADOS: Supabase Local.

--------------------------------------------------------------------------------
1. O PROBLEMA DA VALIDA√á√ÉO (THE HANDSHAKE)
--------------------------------------------------------------------------------
O banco local precisa confiar no token gerado pela nuvem.
Como voc√™ observou corretamente, o termo "Legacy JWT Secret" aparece em alguns lugares,
mas a mec√¢nica para Self-Hosting/Local Dev exige que definamos uma chave de assinatura.

--------------------------------------------------------------------------------
2. ONDE PEGAR A CHAVE NA NUVEM
--------------------------------------------------------------------------------
1. V√° no Supabase Dashboard (Cloud).
2. Project Settings -> API.
3. Procure a se√ß√£o "JWT Settings".
4. Voc√™ ver√° o campo "JWT Secret".
   *Nota: Mesmo que a interface diga que √© legacy ou sugira Signing Keys, para
   fins de desenvolvimento h√≠brido, este √© o segredo HS256 que precisamos.*
   -> Copie este valor.

--------------------------------------------------------------------------------
3. ONDE COLOCAR A CHAVE NO LOCAL (SUPABASE CLI)
--------------------------------------------------------------------------------
A confus√£o comum √© procurar no `config.toml`. Nas vers√µes modernas da CLI,
isso √© gerenciado pelo arquivo `.env` dentro da pasta `supabase/`.

1. Na raiz do seu projeto, entre na pasta `supabase/`.
2. Abra (ou crie) o arquivo `.env`.
   (Nota: N√£o confunda com o `.env` da raiz do frontend React).
3. Procure ou adicione a vari√°vel:

   SUPABASE_AUTH_JWT_SECRET="<COLE_A_CHAVE_DA_NUVEM_AQUI>"

4. Se voc√™ estiver usando docker-compose puro (sem CLI), procure no seu
   `docker-compose.yml` pela vari√°vel `JWT_SECRET` ou `PGRST_JWT_SECRET`.

5. REINICIE O SUPABASE:
   $ npx supabase stop
   $ npx supabase start

   Ao reiniciar, o output do terminal deve mostrar a chave atualizada.

--------------------------------------------------------------------------------
4. CONFIGURA√á√ÉO DO FRONTEND (.env)
--------------------------------------------------------------------------------
No arquivo `.env` da raiz do projeto React (Vite):

# URL e Key do Projeto CLOUD (Para Login)
VITE_CLOUD_AUTH_URL="https://seu-projeto.supabase.co"
VITE_CLOUD_AUTH_KEY="<ANON_KEY_DA_NUVEM>"

# URL e Key do Projeto LOCAL (Para Dados)
VITE_LOCAL_DB_URL="http://127.0.0.1:54321"
VITE_LOCAL_DB_KEY="<ANON_KEY_LOCAL>"

--------------------------------------------------------------------------------
5. RESUMO T√âCNICO
--------------------------------------------------------------------------------
O Frontend pega o token do Cloud e o envia para o Local.
O Local pega esse token e tenta validar a assinatura usando o `SUPABASE_AUTH_JWT_SECRET`.
Se as chaves baterem, o RLS funciona e o usu√°rio √© identificado.

--------------------------------------------------------------------------------
6. DETALHAMENTO T√âCNICO: O QUE ACONTECE POR TR√ÅS DOS PANOS
--------------------------------------------------------------------------------

Para entender por que isso funciona, precisamos dissecar o JWT (JSON Web Token).

1. A ANATOMIA DO TOKEN
   Um JWT √© composto por tr√™s partes: Header.Payload.Signature

   - Payload: Cont√©m os dados do usu√°rio (ID, Email, Role).
   - Signature: √â um hash criptogr√°fico gerado assim:
     HMACSHA256(base64(Header) + "." + base64(Payload), SEGREDO)

2. O PROCESSO

   A) NA NUVEM (Emissor):
      O Supabase Cloud gera o token usando o SEGREDO_A.
      Token = Dados + Hash(Dados + SEGREDO_A).

   B) NO FRONTEND (Transportador):
      O React recebe esse token da nuvem. Ele n√£o sabe o segredo, apenas armazena 
      o token e o coloca no Header `Authorization: Bearer ...` das requisi√ß√µes para o banco local.

   C) NO LOCAL (Validador):
      O PostgREST (motor do Supabase Local) recebe a requisi√ß√£o.
      Ele l√™ o token e separa a Assinatura.
      
      Para validar, ele pensa: "Se eu pegar os dados desse token e assinar com o MEU
      segredo local, o resultado √© igual √† assinatura que veio no token?"

3. O PULO DO GATO
   Como configuramos o Local (`SUPABASE_AUTH_JWT_SECRET`) com o mesmo SEGREDO_A da nuvem, 
   a matem√°tica bate.
   
   O PostgREST aceita o token como leg√≠timo e extrai o User ID (`sub`) de dentro do Payload.
   Ele ent√£o define a vari√°vel de sess√£o `auth.uid()` com esse ID.
   
   Portanto, suas Policies RLS (ex: `auth.uid() = user_id`) funcionam perfeitamente no banco local,
   mesmo que o usu√°rio tecnicamente nunca tenha feito "login" no servidor local.
   A confian√ßa √© estabelecida puramente pela criptografia (Shared Secret).

   
================================================================================
GUIA DE INTEGRA√á√ÉO TYDA: CLOUD AUTH + LOCAL DATABASE
================================================================================

Este projeto utiliza uma arquitetura h√≠brida:
- AUTENTICA√á√ÉO: Supabase Cloud.
- DADOS: Supabase Local.

--------------------------------------------------------------------------------
üî• SOLU√á√ÉO DE ERROS (TROUBLESHOOTING)
--------------------------------------------------------------------------------

1. ERRO "PGRST301 - No suitable key was found to decode the JWT"
   Sintoma: O console mostra erro 401 (Unauthorized) ao acessar o banco local.
   Causa: O Supabase Local tem um "JWT Secret" diferente do Supabase Cloud. O Cloud assina o token, mas o Local n√£o consegue ler.

   SOLU√á√ÉO PASSO-A-PASSO:
   1. V√° no Supabase Dashboard (Cloud) > Project Settings > API.
   2. Copie o "JWT Secret" (mesmo que diga "legacy" ou oculto).
   3. No seu VS Code, abra o arquivo `supabase/config.toml`.
   4. Encontre a linha `jwt_secret` dentro de `[auth]`.
   5. Cole o secret da nuvem: `jwt_secret = "seu-secret-copiado-da-nuvem"`.
   6. Pare o servidor local: `npx supabase stop`.
   7. Inicie novamente: `npx supabase start`.
   8. ATEN√á√ÉO: O terminal vai mostrar novas chaves (anon key / service_role key).
   9. Copie a NOVA `anon key` e atualize o arquivo `.env` do frontend (VITE_LOCAL_DB_KEY).

--------------------------------------------------------------------------------
2. CONFIGURA√á√ÉO GERAL
--------------------------------------------------------------------------------
No arquivo `.env` da raiz do projeto React (Vite):

# URL e Key do Projeto CLOUD (Para Login)
VITE_CLOUD_AUTH_URL="https://seu-projeto.supabase.co"
VITE_CLOUD_AUTH_KEY="<ANON_KEY_DA_NUVEM>"

# URL e Key do Projeto LOCAL (Para Dados)
VITE_LOCAL_DB_URL="http://127.0.0.1:54321"
VITE_LOCAL_DB_KEY="<NOVA_ANON_KEY_LOCAL_POS_RESET>"

--------------------------------------------------------------------------------
3. RESUMO T√âCNICO
--------------------------------------------------------------------------------
O Frontend pega o token do Cloud e o envia para o Local.
O Local pega esse token e tenta validar a assinatura usando o `jwt_secret`.
Se as chaves baterem, o RLS funciona e o usu√°rio √© identificado.
